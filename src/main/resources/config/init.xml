<?xml version="1.0" encoding="UTF-8"?>
<!--
 ~  Copyright (c) 2025, WSO2 LLC. (http://www.wso2.org) All Rights Reserved.
 ~
 ~  WSO2 LLC. licenses this file to you under the Apache License,
 ~  Version 2.0 (the "License"); you may not use this file except
 ~  in compliance with the License.
 ~  You may obtain a copy of the License at
 ~
 ~    http://www.apache.org/licenses/LICENSE-2.0
 ~
 ~  Unless required by applicable law or agreed to in writing,
 ~  software distributed under the License is distributed on an
 ~  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 ~  KIND, either express or implied.  See the License for the
 ~  specific language governing permissions and limitations
 ~  under the License.
-->
<template name="init" xmlns="http://ws.apache.org/ns/synapse" onError="fault">

    <!-- Common -->
    <parameter name="connectionName" description="Unique name for this connection."/>
    <parameter name="connectionType"
               description="The type of authentication used to connect to Salesforce. (OAuth2 | BasicAuth)"/>
    <parameter name="grantType"
               description="OAuth 2.0 grant type (Authorization Code, Client Credentials, Refresh Token, Password)."/>
    <parameter name="scope" description="Space-separated OAuth scopes (optional)."/>

    <!-- OAuth2 Specific -->
    <parameter name="clientId" description="Connected-App Consumer Key."/>
    <parameter name="clientSecret" description="Connected-App Consumer Secret."/>
    <parameter name="tokenUrl" description="Token endpoint (e.g. https://login.salesforce.com/services/oauth2/token)."/>
    <parameter name="redirectUri" description="Redirect URI configured in Connected App (Auth-Code flow only)."/>
    <parameter name="code" description="Short-lived authorization code (Auth-Code flow only)."/>
    <parameter name="instanceUrl" description="Override instance URL for API calls (optional)."/>
    <parameter name="apiVersion" description="Salesforce REST API version (e.g. v60.0)."/>

    <!-- Password flow specifics -->
    <parameter name="username" description="Org username (Password flow or Basic Auth)."/>
    <parameter name="password" description="Password (append security token)."/>
    <parameter name="securityToken" description="Security token (Password flow)."/>
    <parameter name="loginUrl" description="The login URL to get the user access (Basic Auth)."/>
    <parameter name="forceLogin" description="Whether to force new login (Basic Auth)."/>

    <!-- Refresh Token Flow -->
    <parameter name="refreshToken" description="Refresh token (Refresh-Token flow)."/>

    <!-- Advanced -->
    <parameter name="timeout" description="Connection timeout in ms (default 3000)."/>
    <parameter name="readTimeout" description="Socket read timeout in ms."/>
    <parameter name="blocking" description="True = blocking invocations."/>

    <property name="salesforceRestBlocking" expression="$func:blocking"/>
    <property name="timeout" expression="$func:timeout"/>

    <sequence>
        <!-- Capture connection type -->
        <property name="connectionType"
                  expression="fn:lower-case($func:connectionType)"
                  scope="default"/>
        <!-- Branch on BasicAuth vs OAuth2 -->
        <filter xpath="get-property('connectionType') = 'basicauth'">
            <then>
                <!-- Delegate SOAP login to Java mediator -->
                <class name="org.wso2.carbon.salesforce.connector.SalesforceSOAPLoginHandler"/>
                <!-- Restore original payload -->
                <enrich>
                    <source clone="true" property="ORIGINAL_MSG_PAYLOAD" type="property"/>
                    <target type="body"/>
                </enrich>
            </then>
            <else>
                <!-- OAuth2 Flow -->
                <class name="org.wso2.carbon.salesforce.connector.SalesforceOAuthAccessTokenHandler"/>
                <header name="Authorization"
                        expression="fn:concat('Bearer ', $ctx:_OH_INTERNAL_ACCESS_TOKEN_)"
                        scope="transport"/>
            </else>
        </filter>
    </sequence>
</template>
